<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="个人的技术分享和生活点滴记录"><meta name="keywords" content="Rearib"><title>Django(1)-Web框架本质探究 | Rearib的个人博客</title><link rel="stylesheet" type="text/css" href="//fonts.neworld.org/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Django(1)-Web框架本质探究</h1><a id="logo" href="/.">Rearib的个人博客</a><p class="description">一生温暖纯良，不舍爱与自由</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Arama"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">Django(1)-Web框架本质探究</h1><div class="post-meta"><a href="/2018/10/01/Django(1)-Web框架本质探究/#comments" class="comment-count"></a><p><span class="date">Oct 01, 2018</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><h2 id="Web框架本质"><a href="#Web框架本质" class="headerlink" title="Web框架本质"></a>Web框架本质</h2><p>&emsp;&emsp;对于所有的Web应用，本质上其实就是一个socket服务端，用户的浏览器其实就是一个socket客户端。对于真实开发中的python web程序来说，一般会分为两部分：<strong>服务器程序</strong>和<strong>应用程序</strong>。服务器程序负责对socket服务器进行封装，并在请求到来时，对请求的各种数据进行整理。应用程序则负责具体的逻辑处理。<br><a id="more"></a><br>&emsp;&emsp;为了方便应用程序的开发,就会出现许多的Web框架,而所有的web框架都需要与服务器程序配合才能为用户服务，所以web框架和web服务器之间需要标准化。</p>
<h2 id="一般Web框架架构"><a href="#一般Web框架架构" class="headerlink" title="一般Web框架架构"></a>一般Web框架架构</h2><p><img src="http://qiniu.rearib.top/20181804/1421-S.png" alt=""><br>&emsp;&emsp;大多数基于Python的web框架，如Django、tornado、flask、webpy都是在这个范围内进行增删裁剪的。例如Tornado用的是自己的异步非阻塞“WSGI”网关接口，Flask则只提供了最精简和基本的框架，Django则是直接使用了现成的WSGI，并实现了大部分功能，提供了大量的应用工具。</p>
<blockquote>
<p>MTV设计模式</p>
</blockquote>
<p><img src="http://qiniu.rearib.top/20181804/1436-C.png" alt=""></p>
<h3 id="WSGI-uwsgi-uWSGI区别"><a href="#WSGI-uwsgi-uWSGI区别" class="headerlink" title="WSGI-uwsgi-uWSGI区别"></a>WSGI-uwsgi-uWSGI区别</h3><p>&emsp;&emsp;<strong>WSGI</strong>：全称是Web Server Gateway Interface，WSGI不是服务器、python模块、框架、API或者任何软件，只是一种<strong>网关接口</strong>，它是一个Web服务器（如nginx，uWSGI等服务器）与web应用（如用Django框架写的程序）通信的一种规范。<br>&emsp;&emsp;<strong>uwsgi</strong>：一种传输协议，常用于在uWSGI服务器与其他网络服务器的数据通信。<br>&emsp;&emsp;<strong>uWSGI</strong>：是一个web服务器，实现了WSGI协议、uwsgi协议、http协议等。<br><img src="http://qiniu.rearib.top/20181830/0933-9.png" alt=""><br><strong>工作流程:</strong></p>
<ol>
<li>首先客户端请求服务资源。</li>
<li>nginx作为直接对外的服务接口,接收到客户端发送过来的http请求,会解包、分析。</li>
</ol>
<ul>
<li>如果是静态文件请求就根据nginx配置的静态文件目录，返回请求的资源。</li>
<li>如果是动态的请求,nginx就通过配置文件,将请求传递给uWSGI。</li>
</ul>
<ol>
<li>uWSGI将接收到的包进行处理，转发给wsgi。</li>
<li>wsgi根据请求调用django工程的某个文件或函数，处理完后django将返回值交给wsgi。</li>
<li>wsgi将返回值进行打包，转发给uWSGI。</li>
<li>uWSGI接收后转发给nginx,nginx最终将返回值返回给客户端(如浏览器)。</li>
</ol>
<p>&emsp;&emsp;第一级的nginx并不是必须的，uwsgi完全可以完成整个的和浏览器交互的流程，但是要考虑到某些情况：</p>
<ul>
<li>安全问题：程序不能直接被浏览器访问到，而是通过nginx。nginx只开放某个接口，这样运维人员在nginx上加上安全性的限制，可以达到保护程序的作用。</li>
<li>负载均衡问题：一个uwsgi很可能不够用，有了nginx做代理，一个nginx可以代理多台uwsgi完成uwsgi的负载均衡。</li>
<li>静态文件问题：用django或是uwsgi这种东西来负责静态文件的处理是很浪费的行为，而且他们本身对文件的处理也不如nginx好，所以整个静态文件的处理都直接由nginx完成，静态文件的访问完全不去经过uwsgi以及其后面的东西。</li>
</ul>
<h3 id="通过对Django的启动研究socket的启动"><a href="#通过对Django的启动研究socket的启动" class="headerlink" title="通过对Django的启动研究socket的启动"></a>通过对Django的启动研究socket的启动</h3><p>&emsp;&emsp;<strong>使用runserver是启动Django自带的WSGI服务器</strong>，常用于开发调试，分析Django的源码:</p>
<ul>
<li>执行<code>python manage.py runserver 127.0.0.1:8000</code>后，会在<code>\Django1.11.6\Lib\site-packages\django\core\management\__init__.py</code>中执行<code>self.fetch_command(subcommand).run_from_argv(self.argv)</code>。</li>
<li>调用<code>fetch_command</code>返回的<code>runserver</code>模块下的<code>Command</code>对象，其中Command对象是<code>&lt;django.contrib.staticfiles.management.commands.runserver.Command object&gt;</code>，继续调用<code>Command</code>对象的<code>run_from_argv</code>方法，然后执行<code>self.handle(*args, **options)</code>调用<code>Command</code>下的<code>handle</code>。</li>
<li><p>从<code>Command.handle</code>–&gt;<code>Command.run</code>–&gt;<code>Command.inner_run</code>，并在inner_run中执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">handler = self.get_handler(*args, **options)</span><br><span class="line">run(self.addr, int(self.port), handler,</span><br><span class="line">    ipv6=self.use_ipv6, threading=threading, server_cls=self.server_cls)</span><br></pre></td></tr></table></figure>
</li>
<li><p>在<code>get_handler</code>中会在通过<code>wsgi.py</code>返回<code>WSGIHandler()</code>，继承于<code>class WSGIHandler(base.BaseHandler)</code>，然后会执行run:</p>
</li>
<li><p>而run就是启动一个线程一直监听，其中<code>wsgi_handler</code>是<code>WSGIHandler()</code>，<code>server_cls=WSGIServer</code>是继承于<code>class WSGIServer(simple_server.WSGIServer, object)</code>，而<code>simple_server</code>来自于<code>from wsgiref import simple_server</code>，而wsgiref就是Python内置的一个WSGI服务器。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">def run(addr, port, wsgi_handler, ipv6=False, threading=False, server_cls=WSGIServer):</span><br><span class="line">    server_address = (addr, port)</span><br><span class="line">    if threading:</span><br><span class="line">        httpd_cls = type(str(&apos;WSGIServer&apos;), (socketserver.ThreadingMixIn, server_cls), &#123;&#125;)</span><br><span class="line">    else:</span><br><span class="line">        httpd_cls = server_cls</span><br><span class="line">    httpd = httpd_cls(server_address, WSGIRequestHandler, ipv6=ipv6)</span><br><span class="line">    if threading:</span><br><span class="line">        # ThreadingMixIn.daemon_threads indicates how threads will behave on an</span><br><span class="line">        # abrupt shutdown; like quitting the server by the user or restarting</span><br><span class="line">        # by the auto-reloader. True means the server will not wait for thread</span><br><span class="line">        # termination before it quits. This will make auto-reloader faster</span><br><span class="line">        # and will prevent the need to kill the server manually if a thread</span><br><span class="line">        # isn&apos;t terminating correctly.</span><br><span class="line">        httpd.daemon_threads = True</span><br><span class="line">    httpd.set_app(wsgi_handler)</span><br><span class="line">    httpd.serve_forever()</span><br></pre></td></tr></table></figure>
</li>
<li><p>wsgiref是用纯Python编写的WSGI服务器的参考实现。所谓“参考实现”是指该实现完全符合WSGI标准，但是不考虑任何运行效率，仅供开发和测试使用。</p>
</li>
</ul>
<p>参考文章:</p>
<ul>
<li><a href="https://www.cnblogs.com/luchuangao/articles/7374415.html" target="_blank" rel="noopener">由django.setup()引发得对Django启动过程解读</a></li>
<li><a href="http://www.javabin.cn/2018/django_start.html" target="_blank" rel="noopener">Django 源码学习之搭建环境和django启动流程(一)</a></li>
</ul>
</div><div class="tags"><a href="/tags/Django/">Django</a></div><div class="post-share"><div class="bdsharebuttonbox"><span style="float:left;line-height: 28px;height: 28px;font-size:16px;font-weight:blod">分享到：</span><a href="#" data-cmd="more" class="bds_more"></a><a href="#" data-cmd="mshare" title="分享到一键分享" class="bds_mshare"></a><a href="#" data-cmd="fbook" title="分享到Facebook" class="bds_fbook"></a><a href="#" data-cmd="twi" title="分享到Twitter" class="bds_twi"></a><a href="#" data-cmd="linkedin" title="分享到linkedin" class="bds_linkedin"></a><a href="#" data-cmd="youdao" title="分享到有道云笔记" class="bds_youdao"></a><a href="#" data-cmd="evernotecn" title="分享到印象笔记" class="bds_evernotecn"></a><a href="#" data-cmd="weixin" title="分享到微信" class="bds_weixin"></a><a href="#" data-cmd="qzone" title="分享到QQ空间" class="bds_qzone"></a><a href="#" data-cmd="tsina" title="分享到新浪微博" class="bds_tsina"></a></div></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Web框架本质"><span class="toc-text">Web框架本质</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一般Web框架架构"><span class="toc-text">一般Web框架架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#WSGI-uwsgi-uWSGI区别"><span class="toc-text">WSGI-uwsgi-uWSGI区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#通过对Django的启动研究socket的启动"><span class="toc-text">通过对Django的启动研究socket的启动</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/10/01/Django(1)-Web框架本质探究/">Django(1)-Web框架本质探究</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/Django/" style="font-size: 15px;">Django</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="http://www.tendcode.com/" title="Tendcode" target="_blank">Tendcode</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Baidu Site Haritası</a> |  <a href="/atom.xml">订阅</a> |  <a href="/about/">关于</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">Rearib.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?7c7a5758117d8eb934731041ec33d337";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","weixin","tsina","qzone","linkedin","fbook","twi","print","renren","sqq","evernotecn","bdysc","tqq","tqf","bdxc","kaixin001","tieba","douban","bdhome","thx","ibaidu","meilishuo","mogujie","diandian","huaban","duitang","hx","fx","youdao","sdo","qingbiji","people","xinhua","mail","isohu","yaolan","wealink","ty","iguba","h163","copy"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"]}};with(document)0[(getElementsByTagName('head')[0]||head).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script></body></html>